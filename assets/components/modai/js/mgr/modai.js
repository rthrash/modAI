!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.modAI=t():e.modAI=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{chatHistory:()=>a,executor:()=>g,history:()=>s,ui:()=>J,window:()=>X});const n={},o="assistant",r=(e,t,o,r,a=!1)=>{const i=n[e];if(!i)return;const s={content:t,role:o,id:r,hidden:a};s.el=i.onAddMessage(s);const d=i.history.push(s)-1;r&&(i.idRef[r]=i.history[d])},a={init:(e,t,a)=>(n[e]||(n[e]={history:[],idRef:{},onAddMessage:t,onUpdateMessage:a}),n[e].onAddMessage=t,n[e].onUpdateMessage=a,{addUserMessage:(t,n)=>{r(e,t,"user",void 0,n)},addAssistantMessage:(t,n)=>{r(e,t,o,n)},updateAssistantMessage:(t,a)=>{((e,t,a)=>{const i=n[e];i&&(i.idRef[t]?(i.idRef[t].content=a,i.onUpdateMessage(i.idRef[t])):r(e,a,o,t))})(e,t,a)},getAssistantMessage:t=>((e,t)=>{const o=n[e];if(o)return o.idRef[t]})(e,t),getMessages:()=>n[e].history,getMessagesHistory:()=>n[e].history.map((e=>({role:e.role,content:e.content})))})},i={},s={_formatOutput(e,t){const n=i[e],o=n.visible>0,r=n.visible!==n.values.length-1;return{value:void 0!==t?t:n.values[n.visible]??null,nextStatus:r,prevStatus:o,current:n.visible+1,total:n.values.length,context:n.context}},insert(e,t,n=!1){const o=i[e];n||(o.visible=o.values.push(t)-1);const r=this._formatOutput(e,t);return"function"==typeof o.syncUI&&o.syncUI(r,n),r},next(e){const t=i[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},prev(e){const t=i[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},init(e,t,n,o={}){return i[e]||(i[e]={visible:-1,values:[],context:o}),i[e].syncUI=t,n&&(i[e].values=[n],i[e].visible=0),{cachedItem:i[e],getData:()=>this._formatOutput(e),getAll:()=>i[e].values,syncUI:()=>{"function"==typeof i[e].syncUI&&i[e].syncUI(this._formatOutput(e),!1)},insert:(t,n=!1)=>this.insert(e,t,n),next:()=>this.next(e),prev:()=>this.prev(e)}}},d={buffered:{chatgpt:{content:e=>{const t=e?.choices?.[0]?.message?.content;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}},image:e=>{const t=e?.data?.[0]?.url;if(!t)throw new Error(_("modai.cmp.failed_request"));return{url:t}}},claude:{content:e=>{const t=e?.content?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}}},gemini:{content:e=>{const t=e?.candidates?.[0]?.content?.parts?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(1e3*Math.random())}`,content:t}},image:e=>{const t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(_("modai.cmp.failed_request"));return{base64:`data:image/png;base64,${t}`}}}},stream:{chatgpt:{content:(e,t)=>{const n=t?.content??"",o=e.choices[0]?.delta?.content||"";return{...t,id:e.id,content:`${n}${o}`}}},claude:{content:(e,t)=>{const n=t?.content??"",o=e.delta?.text||"";return{...t,content:`${n}${o}`}}},gemini:{content:(e,t)=>{const n=t?.content??"",o=e.candidates[0]?.content?.parts[0]?.text||"";return{...t,content:`${n}${o}`}}}}},c=async e=>{if(!e.ok){const t=await e.json();if(t?.error)throw new Error(t.error.message);throw new Error(`${e.status} ${e.statusText}`)}},l=async(e,t,n,o,r)=>{if(!e.body)throw new Error("failed");const a=e.body.getReader(),i=new TextDecoder("utf-8");let s="",c={id:`${t}-${Date.now()}-${Math.round(1e3*Math.random())}`,content:""};for(;!r||!r.aborted;){const{done:e,value:r}=await a.read();if(e)break;const l=i.decode(r,{stream:!0});if("gemini"===t){const e=l.trim().split(",\r\n").map((e=>e.replace(/^\[|]$/g,""))).filter((e=>""!==e.trim()));for(const r of e)try{const e=JSON.parse(r);c=d.stream[t][n](e,c),o&&o(c)}catch{}}if("chatgpt"===t){s+=l;let e,r=0;for(;-1!==(e=s.indexOf("\n",r));){const a=s.slice(r,e).trim();if(r=e+1,a.startsWith("data: ")){const e=a.slice(6);if("[DONE]"===e)continue;try{const r=JSON.parse(e);c=d.stream[t][n](r,c),o&&o(c)}catch{}}}s=s.slice(r)}if("claude"===t){s+=l;let e,r=0;for(;-1!==(e=s.indexOf("\n",r));){const a=s.slice(r,e).trim();if(r=e+1,a.startsWith("data: ")){const e=a.slice(6);try{const r=JSON.parse(e);if("message_start"===r.type){c.id=r.message.id;continue}if("content_block_delta"!==r.type)continue;c=d.stream[t][n](r,c),o&&o(c)}catch{}}}s=s.slice(r)}}return c},p=async(e,t,n,o)=>{const r=(o=o||new AbortController).signal,a=await fetch(`${modAI.apiURL}?action=${e}`,{signal:r,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!a.ok){const e=await a.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}const i=a.headers.get("x-modai-service")??"chatgpt",s=a.headers.get("x-modai-parser")??"content",p=1===parseInt(a.headers.get("x-modai-stream")??"0");if(1!==parseInt(a.headers.get("x-modai-proxy")??"0")){return(async(e,t,n)=>{if("object"!=typeof e||!e.forExecutor)return e;const o=e.forExecutor,r=(n=n||new AbortController).signal;if(!o.service||!o.parser)throw new Error(_("modai.cmp.service_required"));if(!d[o.stream?"stream":"buffered"]?.[o.service]?.[o.parser])throw new Error(_("modai.cmp.service_unsupported"));if(o.stream)return(async e=>{if("content"!==o.parser)throw new Error(_("modai.cmp.service_unsupported"));const n=await fetch(e.url,{signal:r,method:"POST",body:e.body,headers:e.headers});return await c(n),l(n,o.service,o.parser,t)})(o);const a=await(async e=>{const t=await fetch(e.url,{signal:r,method:"POST",body:e.body,headers:e.headers});await c(t);const n=await t.json();if(n.error)throw new Error(n.error.message);return n})(o);return d.buffered[o.service][o.parser](a)})(await a.json(),n,o)}if(!i||!s)throw o.abort(),new Error(_("modai.cmp.service_required"));if(!d[p?"stream":"buffered"]?.[i]?.[s])throw o.abort(),new Error(_("modai.cmp.service_unsupported"));if(!p){const e=await a.json();return d.buffered[i][s](e)}if("content"!==s)throw new Error(_("modai.cmp.service_unsupported"));return await l(a,i,s,n,r)},g={mgr:{download:{image:async e=>await(async(e,t)=>{const n=await fetch(`${modAI.apiURL}?action=Download\\Image`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!n.ok){const e=await n.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}return n.json()})(0,e)},prompt:{freeText:async(e,t,n)=>p("Prompt\\FreeText",e,t,n),text:async(e,t,n)=>p("Prompt\\Text",e,t,n),vision:async(e,t,n)=>p("Prompt\\Vision",e,t,n),image:async(e,t)=>p("Prompt\\Image",e,void 0,t)}}},h={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.3)",display:"none",zIndex:"100"},u={position:"fixed",width:"1000px",minHeight:"170px",maxHeight:"600px",backgroundColor:"#fff",borderRadius:"10px",boxShadow:"0 5px 15px rgba(0, 0, 0, 0.3)",display:"none",flexDirection:"column",overflow:"hidden",zIndex:"101",top:"50%",left:"50%",transform:"translate(-50%, -50%)",transition:"height 0.3s ease-in-out"},f={backgroundColor:"#00B6DE",color:"white",padding:"15px",display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"move"},m={fontWeight:"bold",fontSize:"16px"},x={display:"flex",gap:"10px"},b={background:"none",border:"none",color:"white",fontSize:"16px",cursor:"pointer"},w={flex:"1",padding:"15px",overflowY:"auto",backgroundColor:"#f9f9f9",width:"100%",boxSizing:"border-box",display:"none"},y={marginBottom:"20px",borderRadius:"8px",position:"relative",wordWrap:"break-word",width:"100%",boxSizing:"border-box"},v={width:"100%",backgroundColor:"#ffffff",border:"1px solid #e2e8f0",boxShadow:"0 2px 5px rgba(0, 0, 0, 0.05)"},C={width:"fit-content",padding:"10px 15px",backgroundColor:"#4299e1",color:"white",marginLeft:"auto",borderBottomRightRadius:"5px"},k={padding:"12px",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box"},M={display:"flex",padding:"8px 12px",gap:"8px",backgroundColor:"#f7fafc",borderTop:"1px solid #e2e8f0",borderRadius:"0 0 8px 8px"},E={backgroundColor:"#edf2f7",border:"1px solid #cbd5e0",borderRadius:"4px",padding:"3px 8px",fontSize:"12px",cursor:"pointer",display:"flex",alignItems:"center",color:"#4a5568"},I={display:"flex",padding:"15px",borderTop:"1px solid #e2e8f0",backgroundColor:"white",position:"relative"},z={display:"flex",width:"100%",gap:"10px"},T={flex:"1",position:"relative",minHeight:"48px",maxHeight:"150px",display:"flex"},A={width:"100%",padding:"12px 15px",border:"1px solid #e2e8f0",borderRadius:"20px",outline:"none",fontSize:"14px",resize:"none",minHeight:"48px",maxHeight:"150px",overflowY:"auto",backgroundColor:"#fff",cursor:"inherit"},S={display:"flex",flexDirection:"column",gap:"4px",width:"100px"},H={backgroundColor:"#6CB24A",color:"white",border:"none",borderRadius:"12px",padding:"8px 16px",cursor:"pointer",fontWeight:"bold",height:"40px",minWidth:"100px",fontSize:"14px",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",opacity:"1"},O={display:"flex",gap:"4px",justifyContent:"space-between"},L={backgroundColor:"transparent",border:"1px solid #e2e8f0",borderRadius:"8px",width:"48px",height:"32px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",opacity:"1"},B={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},R={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23DC2626'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 6h12v12H6z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},j={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234B5563'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},D={display:"inline-block",width:"14px",height:"14px",marginRight:"5px",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},$={opacity:"0.5",cursor:"not-allowed"},P={backgroundColor:"#f3f4f6",cursor:"not-allowed"},U={display:"none",position:"absolute",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(243, 244, 246, 0.9)",borderRadius:"20px",color:"#6B7280",fontSize:"14px",alignItems:"center",justifyContent:"center",gap:"4px",flexDirection:"row",zIndex:"10",backdropFilter:"blur(2px)",border:"1px solid #e2e8f0",pointerEvents:"none"},N={width:"fit-content",padding:"10px 15px",backgroundColor:"#DC2626",color:"white",marginLeft:"auto",borderBottomRightRadius:"5px",display:"flex",alignItems:"center",gap:"8px"},V={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},W=(e,t)=>{Object.assign(e.style,t)},q=(e,t,n="")=>{const o=document.createElement(e);return t&&W(o,t),n&&(o.textContent=n),o},Y=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>"),J={freePrompt:e=>(e=>{if(!e.key)return void alert("key is required config property");const t=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r),G.modalOverlay&&G.modalOverlay.remove(),G&&G.remove()},n=e=>{G.isDragging=!0;const t=G.getBoundingClientRect();G.offsetX=e.clientX-t.left,G.offsetY=e.clientY-t.top,document.body.style.userSelect="none"},o=e=>{if(!G.isDragging)return;const t=e.clientX-G.offsetX,n=e.clientY-G.offsetY;G.style.left=t+"px",G.style.top=n+"px",G.style.transform="none"},r=()=>{G.isDragging=!1,document.body.style.userSelect=""},i=()=>{G.isLoading&&G.abortController&&(G.abortController.abort(),G.abortController=void 0,J(!1))},s=()=>{0!==F.getMessages().length&&X("Try again")},d=e=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const t=q("div",{...y,...C});return t.innerHTML=Y(e),G.chatMessages.appendChild(t),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,t},c=e=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const t=q("div",{...y,...N}),n=q("span",V);t.appendChild(n);const o=q("span");return o.textContent=e,t.appendChild(o),G.chatMessages.appendChild(t),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,t},l=(n,o)=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const r=q("div",{...y,...v}),a=o||"msg-"+Date.now();r.dataset.messageId=a;const i=q("div",k),s=((e,t,n=[])=>{const o=Y(e),r=q("iframe",{width:"100%",border:"none",backgroundColor:"white",pointerEvents:"none",maxWidth:"100%",boxSizing:"border-box"});return r.srcdoc=`\n        <html>\n        <head>\n            <style>\n                html {\n                    width: 100%;\n                    max-width: 100%;\n                    padding: 0;\n                    margin: 0;\n                }\n                body {\n                    margin: 0;\n                    padding: 0;\n                    font-family: Arial, sans-serif;\n                    overflow-x: hidden;\n                    width: 100%;\n                    max-width: 100%;\n                    box-sizing: border-box;\n                }\n                * {\n                    box-sizing: border-box;\n                    max-width: 100%;\n                }\n                pre {\n                    white-space: pre-wrap;\n                    word-wrap: break-word;\n                    overflow-wrap: break-word;\n                    max-width: 100%;\n                    padding: 12px;\n                    margin: 0;\n                    background-color: #f5f7fa;\n                    border-radius: 5px;\n                    font-size: 14px;\n                }\n                img {\n                    max-width: 100%;\n                    height: auto;\n                    display: block;\n                }\n                code {\n                    white-space: pre-wrap;\n                    word-wrap: break-word;\n                    max-width: 100%;\n                    display: block;\n                    overflow-x: hidden;\n                    font-size: 14px;\n                }\n                table {\n                    width: 100%;\n                    max-width: 100%;\n                    overflow-x: hidden;\n                    display: block;\n                    border-collapse: collapse;\n                }\n                div {\n                    max-width: 100%;\n                    overflow-wrap: break-word;\n                    word-wrap: break-word;\n                    box-sizing: border-box;\n                }\n                p {\n                    margin: 0 0 0.5em 0;\n                    max-width: 100%;\n                }\n                h1, h2, h3, h4, h5, h6 {\n                    margin: 0 0 0.1em 0;\n                    max-width: 100%;\n                }\n            </style>\n            ${n.map((e=>`<link rel="stylesheet" type="text/css" href="${e}" />`)).join("")}\n        </head>\n        <body style="padding: 0; max-width: 100%; width: 100%; box-sizing: border-box;">${o}</body>\n        </html>\n    `,r.syncHeight=()=>{const e=r.contentWindow?.document.body;if(!e)return;const n=e.getElementsByTagName("*");let o=e.offsetHeight;for(let e=0;e<n.length;e++){const t=n[e],r=t.offsetTop+t.offsetHeight;o=Math.max(o,r)}r.style.height=o+5+"px",e.style.overflow="hidden",t.chatMessages.scrollTop=t.chatMessages.scrollHeight},r.onload=r.syncHeight,r})(n,G,e.customCSS??[]);i.appendChild(s);const d=q("div",M),c=q("button",E),l=q("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z'/%3E%3Cpath d='M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z'/%3E%3C/svg%3E\")"});c.append(l,document.createTextNode("Copy")),c.addEventListener("click",(()=>p(a,c))),d.append(c);const g=e.actions?.insert;if(g&&"function"==typeof g){const e=q("button",E),n=q("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z'/%3E%3Cpath d='M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z'/%3E%3C/svg%3E\")"});e.append(n,document.createTextNode("Insert")),e.addEventListener("click",(()=>g(F.getAssistantMessage(a),t))),d.append(e)}return r.append(i,d),G.chatMessages.appendChild(r),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,r},p=(e,t)=>{const n=F.getAssistantMessage(e);if(!n)return;if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(n.content).then((()=>{})).catch((()=>{c(_("modai.cmp.failed_copy"))}));else try{const e=q("textarea");e.value=n.content,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}catch(e){c(_("modai.cmp.failed_copy"))}const o=t.innerHTML,r=q("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z'/%3E%3Cpath d='M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z'/%3E%3C/svg%3E\")"});t.innerHTML="",t.append(r,document.createTextNode("Copied!")),setTimeout((()=>{t.innerHTML=o}),2e3)},J=e=>{G.isLoading=e,G.loadingIndicator.style.display=e?"flex":"none",G.messageInput.disabled=e,W(G.messageInput,e?{...A,...P}:A),G.sendBtn.disabled=e,W(G.sendBtn,e?{...H,...$}:H),G.stopBtn.disabled=!e,W(G.stopBtn,e?L:{...L,...$});const t=F.getMessages().length>0;G.tryAgainBtn.disabled=e||!t,W(G.tryAgainBtn,e||!t?{...L,...$}:L)},X=async(t,n)=>{const o=t?t.trim():G.messageInput.value.trim();if(!o||G.isLoading)return;J(!0),G.messageInput.value="",G.abortController=new AbortController;const r=F.getMessagesHistory();F.addUserMessage(o,n);try{const t=await g.mgr.prompt.freeText({namespace:e.namespace,context:e.context,prompt:o,field:e.field||"",messages:r},(e=>{F.updateAssistantMessage(e.id,e.content)}),G.abortController);F.updateAssistantMessage(t.id,t.content),G.abortController=void 0}catch(e){if(e instanceof Error){if("AbortError"===e.name)return;return void c(e.message)}c("Unknown error")}J(!1)},F=a.init(e.key,(e=>{if(!e.hidden)return"user"===e.role?d(e.content):l(e.content,e.id)}),(e=>{if(!e.el)return;if("user"===e.role)return void(e.el.textContent=e.content);const t=e.el?.firstChild?.firstChild;if(!t)return;const n=t.contentDocument;n&&(n.body.innerHTML=Y(e.content),t.syncHeight())})),G=(()=>{const e=q("div",h),a=q("div",u),d=q("div",f),c=q("div",m,"modAI Assistant"),l=q("div",x),p=q("button",b,"âœ•");l.append(p),d.append(c,l);const g=q("div",w),y=q("div",I),v=q("div",z),C=q("div",T),k=q("textarea",A);k.placeholder="Type your message...";const M=q("div",S),E=q("button",H),_=q("span",B),D=document.createTextNode("Send");E.append(_,D);const P=q("div",O),N=q("button",{...L,...$}),V=q("span",R);N.appendChild(V),N.title="Stop Generation";const Y=q("button",L),J=q("span",j);Y.appendChild(J),Y.title="Try Again",0===F.getMessages().length&&(Y.disabled=!0,W(Y,{...L,...$})),P.append(N,Y),M.append(E,P),C.append(k),v.append(C,M);const G=q("div",U);return G.innerHTML='\n        <style>\n            @keyframes loadingDotPulse {\n                0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }\n                40% { transform: scale(1); opacity: 1; }\n            }\n            .loading-dots {\n                display: flex;\n                gap: 4px;\n                padding: 8px 16px;\n                background-color: rgba(255, 255, 255, 0.8);\n                border-radius: 16px;\n            }\n            .loading-dot {\n                width: 8px;\n                height: 8px;\n                background-color: #6B7280;\n                border-radius: 50%;\n                display: inline-block;\n                animation: loadingDotPulse 1.4s infinite ease-in-out both;\n            }\n            .loading-dot:nth-child(1) { animation-delay: -0.32s; }\n            .loading-dot:nth-child(2) { animation-delay: -0.16s; }\n            .loading-dot:nth-child(3) { animation-delay: 0s; }\n        </style>\n        <div class="loading-dots">\n            <div class="loading-dot"></div>\n            <div class="loading-dot"></div>\n            <div class="loading-dot"></div>\n        </div>\n    ',C.append(G),y.append(v),a.append(d,g,y),document.body.append(e,a),p.addEventListener("click",t),E.addEventListener("click",(()=>X())),N.addEventListener("click",i),Y.addEventListener("click",s),k.addEventListener("keydown",(e=>{if("Enter"===e.key){if(e.shiftKey)return;e.preventDefault(),X()}})),d.addEventListener("mousedown",n),document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),a.modalOverlay=e,a.chatHeader=d,a.closeBtn=p,a.chatMessages=g,a.messageInput=k,a.sendBtn=E,a.tryAgainBtn=Y,a.stopBtn=N,a.loadingIndicator=G,a.isDragging=!1,a.isLoading=!1,a.abortController=void 0,a.offsetX=0,a.offsetY=0,a})();return G.api={sendMessage:X,closeModal:t},(()=>{G.chatMessages.innerHTML="",G.chatMessages.style.display="none",G.style.visibility="hidden",G.style.display="flex",G.modalOverlay.style.display="block";const e=F.getMessages().filter((e=>!e.hidden));e.length>0&&(G.chatMessages.style.display="block",e.forEach((e=>{"user"===e.role?d(e.content):l(e.content,e.id)}))),setTimeout((()=>{G.chatMessages.scrollTop=G.chatMessages.scrollHeight,G.style.visibility="visible"}),100)})(),G})(e)},X={};return t})()));